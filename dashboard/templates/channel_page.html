{% extends "base.html" %}
{% load staticfiles %}

{% block header %}
    <!--[if IE]>
    <script type="text/javascript" src="{% static "dashboard/js/excanvas.js" %}" />
    <![endif]-->
    <script type="text/javascript" src="{% static "dashboard/js/dygraph-combined.js" %}"></script>
    <script type="text/javascript" src="{% static "dashboard/js/jquery.min.js" %}"></script>
{% endblock header %}

{% block content %}
    <!--
    <h2>{{ channel.name }} - {{ channel.points.count }} points</h2>
    <h3>Latest Point at: <b id="latest-point"></b></h3>
    <h4>Switch Status: {{status.status}}</h4>
    <h4>Channel num: {{channel.channel_num}}</h4>
    -->
    <h2>Board: {{channel.board}}</h2>
    <h3>Channel: {{channel.channel_num}}</h3>

    <button id="switch" onclick="button_press({{channel.channel_num}})">hello <!--onblur="button_status({{status.status}})--></button>

    <div id="chart_div" style="height:60%; width:80%; margin:auto; background-color:lightblue"></div>
    
    <script type="text/javascript">
        function button_status(num) {
            //decode whether button is on/off
            var i = {{channel.channel_num}};
            document.getElementById("switch").innerHTML = num;
            var mask = 1<<(i-1);
            if((num & mask ) != 0) {
                  document.getElementById("switch").innerHTML = "On";
                  document.getElementById("switch").style.color = "Green";
              } else {
                  document.getElementById("switch").innerHTML = "Off";
                  document.getElementById("switch").style.color = "Red";
              }
        }

        function button_press(num){
            var jsonData = $.ajax({
              url: "{% url 'button_press' 123 %}".replace("123",num),
              dataType: 'json'
            }).done(function (results) { 
                    button_status(results)});
        }

        function button_poll() {
            //button polling
            var jsonData = $.ajax({
              url: "{% url 'get_status' 123 %}".replace("123",{{channel.board.id}}),
              dataType: 'json'
            }).done(function (results) {
                    button_status(results)});
            setTimeout(button_poll,1000);
        }

        function get_new_data(){
            if (data.length > 0) {
                address = "{% url 'channel_data' channel.id %}" + Math.ceil(data[data.length-1][0].getTime()/1000) + "/";
            } else {
                if ({{ timestart }}) {
                    address = "{% url 'channel_data' channel.id %}" + Math.ceil(new Date().getTime()/1000 - {{ timestart }}) + "/";
                } else {
                    address = "{% url 'channel_data' channel.id %}";
                }
                
            }
            var jsonData = $.ajax({
              url: address,
              dataType: 'json'
            }).done(function (results) {
                for (var i = 0; i < results.length; i++){
                    data.push([new Date(results[i][0]*1000),results[i][1]]);
                }
                var needs_update = false;
                if (results.length) {
                    $('#latest-point').html(data[data.length-1][0]);
                    $('#latest-point').fadeTo(0, 0.25).fadeTo(1500, 1.0);
                    var needs_update = true;
                }
                if ({{ timestart }}) {
                    var d = new Date().getTime();
                    while (data.length && ((d-data[0][0].getTime())/1000 > {{ timestart }})) {
                        data.splice(0,1);
                        needs_update = true;
                    }
                }
                if (needs_update) {
                    g.updateOptions( { 'file': data } );
                }
                setTimeout(get_new_data,3000);
            })
        }
        
        var data = [];
        
        var g = new Dygraph(document.getElementById("chart_div"), data,
                            {
                              drawPoints: false,
                              //valueRange: [0.0, 1.2],
                              labels: ['Time', '{{ channel.units }}'],
                              xlabel: 'Time',
                              ylabel: '{{ channel.units }}',
                            });
        
        get_new_data();
        button_poll();
    </script>
{% endblock content %}